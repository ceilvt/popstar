var BG=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.init,this)}__extends(e,t);var i=(__define,e),s=i.prototype;return s.init=function(t){this.bg=Tools.createBitmapByName("bg"),this.bg.cacheAsBitmap=!0,this.bg.width=Tools.sw(),this.bg.height=Tools.sh(),this.addChild(this.bg)},e}(egret.Sprite);egret.registerClass(BG,"BG");var BlockBG=function(t){function e(){t.call(this),this.init()}__extends(e,t);var i=(__define,e),s=i.prototype;return s.init=function(){this.lifeBar=new LifeBar,this.lifeBar.x=100,this.lifeBar.y=-150,this.addChild(Tools.createBitmapByName("ceil")),this.blockpack=new BlockPack,this.addChild(this.blockpack),this.addChild(this.lifeBar)},e}(egret.Sprite);egret.registerClass(BlockBG,"BlockBG");var BlockPack=function(t){function e(){t.call(this),this.ceilW=8,this.ceilH=9,this.typeN=4,this.dataArr=[],this.mapData=[],this.dicObj={},this.bombArr=[],this.addEventListener(egret.Event.ADDED_TO_STAGE,this.init,this)}__extends(e,t);var i=(__define,e),s=i.prototype;return s.init=function(t){this.connectLine=new egret.Sprite,this.addChild(this.connectLine);for(var e=0;e<this.ceilW*this.ceilH;e++){var i=Math.ceil(Math.random()*this.typeN);this.dataArr.push(i)}this.dataArr=Tools.randomArr(this.dataArr);for(var s=0;s<this.ceilH;s++){this.mapData.push([]);for(var n=0;n<this.ceilW;n++){this.mapData[s].push(1);var r=new BlockUI(this.dataArr[this.ceilW*s+n]);r.data=s+"_"+n,r.pos.x=s,r.pos.y=n,r.x=75*n,r.y=75*s,r.setAddChild(this),this.dicObj[s+"_"+n]=r}}Tools.getInstance().addEventListener(ToolEvent.GAME_TAB_PATTERN,this.handleCore,this)},s.handleCore=function(t){console.log("handle tap"),t.data.bompFlag=!0,this.bombArr.push(t.data),this.checkAllAround(t.data);var e,i,s;if(this.bombArr.length<2)return t.data.bompFlag=!1,void(this.bombArr=[]);for(var n in this.bombArr)e=this.bombArr[n].pos.x,i=this.bombArr[n].pos.y,s=e+"_"+i,this.dicObj[s]=null,this.mapData[e][i]=0,this.removeChild(this.bombArr[n]);this.bombArr=[],this.patternDownAnimate();var r=this;setTimeout(r.patternLeftAnimate(r),1e3)},s.patternDownAnimate=function(){for(var t=0;t<this.ceilW;t++)for(var e=this.ceilH-1;e>-1;e--){for(var i=0,s=this.ceilH-1;s>e;s--)0==this.mapData[s][t]&&i++;this.dicObj[e+"_"+t]&&(this.dicObj[e+"_"+t].disCeil=i)}var n="",r={};for(t=0;t<this.ceilW;t++)for(e=0;e<this.ceilH;e++)if(n=e+"_"+t,this.dicObj[n]){var a=egret.Tween.get(this.dicObj[n]),o=this.dicObj[n].disCeil,h=this.dicObj[n].y;this.dicObj[n].pos.x+=o,r[this.dicObj[n].pos.x+"_"+this.dicObj[n].pos.y]=this.dicObj[n],a.to({y:h+75*o},100*o,egret.Ease.cubicIn)}for(this.dicObj=null,this.dicObj=r,t=0;t<this.ceilW;t++)for(e=0;e<this.ceilH;e++)n=e+"_"+t,this.dicObj[n]?this.mapData[e][t]=1:this.mapData[e][t]=0},s.patternLeftAnimate=function(t){for(var e=0;e<t.ceilW;e++){for(var i=0,s=0;e>s;s++)0==t.mapData[t.ceilH-1][s]&&i++;t.dicObj[t.ceilH-1+"_"+e]&&(t.dicObj[t.ceilH-1+"_"+e].disCeil=i)}var n="",r="",a={};for(e=0;e<t.ceilH;e++)for(var o=0;o<t.ceilW;o++)if(n=e+"_"+o,r=t.ceilH-1+"_"+o,t.dicObj[n]){var h=egret.Tween.get(t.dicObj[n]),c=t.dicObj[r].disCeil,l=t.dicObj[n].x;t.dicObj[n].pos.y-=c,a[t.dicObj[n].pos.x+"_"+t.dicObj[n].pos.y]=t.dicObj[n],h.to({x:l-75*c},100*c,egret.Ease.cubicIn)}for(this.dicObj=null,this.dicObj=a,e=0;e<this.ceilW;e++)for(o=0;o<this.ceilH;o++)n=o+"_"+e,this.dicObj[n]?this.mapData[o][e]=1:this.mapData[o][e]=0},s.checkAllAround=function(t){this.checkLeft(t),this.checkRight(t),this.checkUp(t),this.checkDown(t)},s.checkLeft=function(t){var e=t.pos.x,i=t.pos.y,s=e+"_"+(i-1);this.dicObj[s]&&0!=i&&0!=this.mapData[e][i-1]&&(this.dicObj[s].type!=t.type||this.dicObj[s].bompFlag||(this.dicObj[s].bompFlag=!0,this.bombArr.push(this.dicObj[s]),this.checkAllAround(this.dicObj[s])))},s.checkRight=function(t){var e=t.pos.x,i=t.pos.y,s=e+"_"+(i+1);this.dicObj[s]&&i!=this.ceilW-1&&0!=this.mapData[s]&&(this.dicObj[s].type!=t.type||this.dicObj[s].bompFlag||(this.dicObj[s].bompFlag=!0,this.bombArr.push(this.dicObj[s]),this.checkAllAround(this.dicObj[s])))},s.checkUp=function(t){var e=t.pos.x,i=t.pos.y,s=e-1+"_"+i;this.dicObj[s]&&0!=e&&0!=this.mapData[s]&&(this.dicObj[s].type!=t.type||this.dicObj[s].bompFlag||(this.dicObj[s].bompFlag=!0,this.bombArr.push(this.dicObj[s]),this.checkAllAround(this.dicObj[s])))},s.checkDown=function(t){var e=t.pos.x,i=t.pos.y,s=e+1+"_"+i;this.dicObj[s]&&e!=this.ceilH-1&&0!=this.mapData[e+1][i]&&(this.dicObj[s].type!=t.type||this.dicObj[s].bompFlag||(this.dicObj[s].bompFlag=!0,this.bombArr.push(this.dicObj[s]),this.checkAllAround(this.dicObj[s])))},s.clearBlockUI=function(){var t=Tools.getInstance().lastPattern;this.mapData[t.pos.x][t.pos.y]=0,this.dicObj[t.pos.x+"_"+t.pos.y]=null,this.removeChild(t),Tools.getInstance().lastPattern=null},e}(egret.Sprite);egret.registerClass(BlockPack,"BlockPack");var BlockUI=function(t){function e(e){t.call(this),this.colArr=[16711680,16515327,3539199,52479],this.pos=new egret.Point,this.ifHide=!0,this.disCeil=0,this.type=e}__extends(e,t);var i=(__define,e),s=i.prototype;return s.setAddChild=function(t){t.addChild(this),this.init(),this.addEventListener(egret.Event.REMOVED_FROM_STAGE,this.dispose,this)},s.init=function(){this.createBG(),this.touchEnabled=!0,this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.tapPattern,this),Tools.getInstance().addEventListener(ToolEvent.GAME_OVER,this.gameOver,this)},s.tapPattern=function(t){var e=new ToolEvent(ToolEvent.GAME_TAB_PATTERN);e.data=this,Tools.getInstance().dispatchEvent(e)},s.dispose=function(){this.touchEnabled=!1,this.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.tapPattern,this)},s.setHide1=function(t){this.ifHide=!1},s.setHide2=function(t){this.ifHide=!0},s.createBG=function(){this.addChild(Tools.createBitmapByName("diamond"+this.type+"_png"))},s.gameOver=function(t){this.touchEnabled=!1},e}(egret.Sprite);egret.registerClass(BlockUI,"BlockUI");var FlashLight=function(t){function e(){t.call(this)}__extends(e,t);var i=(__define,e),s=i.prototype;return s.init=function(t,e){this.graphics.clear();var i;t.x!=e.x&&(i=100*Math.abs(t.x-e.x)),t.y!=e.y&&(i=100*Math.abs(t.y-e.y));for(var s=0;s<Math.floor(i/10);s++){var n=10*s+10*Math.random(),r=-5+10*Math.random();this.perDot(n,r)}},s.perDot=function(t,e){var i=Math.floor(16777215*Math.random());this.graphics.beginFill(i),this.graphics.drawCircle(t,e,6),this.graphics.endFill(),console.log(i)},e}(egret.Sprite);egret.registerClass(FlashLight,"FlashLight");var LifeBar=function(t){function e(){t.call(this),this.init()}__extends(e,t);var i=(__define,e),s=i.prototype;return s.init=function(){this.refreshMC=new egret.Sprite,this.refreshMC.x=300,this.refreshMC.addChild(Tools.createBitmapByName("refresh")),this.addChild(this.refreshMC),this.refreshMC.touchEnabled=!0,this.refreshMC.addEventListener(egret.TouchEvent.TOUCH_TAP,this.refreshFun,this),this.createInfoBar()},s.createInfoBar=function(){this.timeTxt=new egret.TextField,this.timeTxt.width=250,this.timeTxt.textColor=0,this.timeTxt.x=48,this.timeTxt.size=40,this.timeTxt.height=60,this.timeTxt.verticalAlign="middle",this.timeTxt.text="30:00",this.addChild(this.timeTxt)},s.startEnterFrame=function(t){this.lastTime=egret.getTimer(),this.addEventListener(egret.Event.ENTER_FRAME,this.checkTime,this)},s.stopEnterFrame=function(t){this.removeEventListener(egret.Event.ENTER_FRAME,this.checkTime,this)},s.checkTime=function(t){var e=egret.getTimer(),i=Math.floor((e-this.lastTime)/100);i>299&&(Tools.getInstance().dispatchEvent(new ToolEvent(ToolEvent.GAME_OVER)),this.removeEventListener(egret.Event.ENTER_FRAME,this.checkTime,this),PopPanel.getInstance().tip("游戏结束，即将跳入结果页!",this.stage)),Tools.getInstance().currentPassTime=Tools.getInstance().totalTime-100*i;var s=Tools.getInstance().currentPassTime,n=Math.floor(s/1e3),r=s%1e3/10,a=0==r?"00":r,o=n>9?n:"0"+n;this.timeTxt.text=o+":"+a},s.refreshFun=function(t){Tools.getInstance().dispatchEvent(new ToolEvent(ToolEvent.GAME_REFRESH))},e}(egret.Sprite);egret.registerClass(LifeBar,"LifeBar");var Line=function(t){function e(e,i,s){t.call(this),this.a=e,this.b=i,this.direct=s}__extends(e,t);var i=(__define,e);i.prototype;return e}(egret.Sprite);egret.registerClass(Line,"Line");var LoadingUI=function(t){function e(){t.call(this),this.createView()}__extends(e,t);var i=(__define,e),s=i.prototype;return s.createView=function(){this.textField=new egret.TextField,this.textField.width=480,this.textField.height=100,this.textField.anchorOffsetX=240,this.textField.x=Tools.sw()/2,this.textField.y=300,this.textField.textAlign="center",this.addChild(this.textField)},s.setProgress=function(t,e){this.textField.text="Loading..."+Math.floor(t/e*100)+"%"},e}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(e,t);var i=(__define,e),s=i.prototype;return s.onAddToStage=function(t){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},s.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.loadGroup("preload")},s.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),this.createGameScene())},s.createGameScene=function(){var t=new BG;this.addChild(t);var e=new BlockBG;this.addChild(e),e.anchorOffsetX=e.width/2,e.anchorOffsetY=e.height/2,e.x=this.stage.stageWidth/2,e.y=this.stage.stageHeight/2+100,setTimeout(function(){Tools.getInstance().dispatchEvent(new ToolEvent(ToolEvent.GAME_START))},1e3)},s.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},s.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},e}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var PopPanel=function(t){function e(){t.call(this)}__extends(e,t);var i=(__define,e),s=i.prototype;return s.init=function(){this.gameoverPanel=new egret.Sprite,this.initBG(),this.initGameoverPanel()},s.initGameoverPanel=function(){this.text=new egret.TextField,this.text.textAlign="left",this.text.width=440,this.text.height=200,this.text.lineSpacing=16,this.text.y=50,this.text.x=Tools.sw()/2-260,this.btn=new egret.Sprite,this.btn.addChild(Tools.createBitmapByName("replay")),this.btn.anchorOffsetX=this.btn.width/2,this.btn.anchorOffsetY=this.btn.height/2,this.btn.y=70,this.btn.touchEnabled=!0,this.btn.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){window.location.href=window.location.href},this),this.gameoverPanel.addChild(this.bg),this.gameoverPanel.addChild(this.text),this.gameoverPanel.addChild(this.btn),this.text.text="游戏结束，数据提交中...";var t=0,e="游戏结束，数据提交中",i=this;setInterval(function(){t++,t%4==0&&(i.text.text=e),t%4==1&&(i.text.text=e+"."),t%4==2&&(i.text.text=e+".."),t%4==3&&(i.text.text=e+"...")},200)},e.getInstance=function(){return null==this.instance&&(this.instance=new e,this.instance.init()),this.instance},s.initBG=function(){this.bg=new egret.Sprite,this.bg.graphics.beginFill(0,.8),this.bg.graphics.drawRect(0,0,Tools.sw(),Tools.sh()),this.bg.graphics.endFill(),this.bg.anchorOffsetX=Tools.sw()/2,this.bg.anchorOffsetY=Tools.sh()/2},s.tip=function(t,e){var i=this;this.text.anchorOffsetX=this.text.width/2,this.text.anchorOffsetY=this.text.height/2,setTimeout(function(){e.addChild(i.gameoverPanel)},500),this.gameoverPanel.x=Tools.sw()/2,this.gameoverPanel.y=Tools.sh()/2},e}(egret.Sprite);egret.registerClass(PopPanel,"PopPanel");var ToolEvent=function(t){function e(e){t.call(this,e)}__extends(e,t);var i=(__define,e);i.prototype;return e.GAME_START="gamestart",e.GAME_OVER="gameover",e.GAME_TAB_PATTERN="gametabpattern",e.GAME_REFRESH="gamerefresh",e}(egret.Event);egret.registerClass(ToolEvent,"ToolEvent");var Tools=function(t){function e(){t.call(this),this.totalTime=3e4,this.currentPassTime=0,this.objLen=72}__extends(e,t);var i=(__define,e),s=i.prototype;return e.sw=function(){var t=egret.MainContext.instance.stage.stageWidth,e=egret.MainContext.instance.stage.stageHeight;return t>e?e:t},e.sh=function(){var t=egret.MainContext.instance.stage.stageWidth,e=egret.MainContext.instance.stage.stageHeight;return t>e?t:e},e.getInstance=function(){return null==e.instance&&(e.instance=new e,e.instance.visible=!1),e.instance},e.createMCByName=function(t,e){var i=RES.getRes(e+".json"),s=RES.getRes(e+".png"),n=new egret.MovieClipDataFactory(i,s),r=new egret.MovieClip(n.generateMovieClipData());return console.log(i),r},e.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.createSpriteSheetByName=function(t){var e=RES.getRes(t),i=new egret.SpriteSheet(e);return i},e.getBitmapFromSheet=function(t,e){var i=RES.getRes(t+"."+e),s=new egret.Bitmap(i);return s},e.getBitmapFont=function(t){var e=RES.getRes(t),i=new egret.BitmapText;return i.font=e,i},e.sendURL=function(t,e){var i=new egret.URLLoader;i.dataFormat=egret.URLLoaderDataFormat.TEXT,i.addEventListener(egret.Event.COMPLETE,function(t){console.log("向服务器数据请求成功,数据为:"+i.data),e(),this.theFastCar=i.data},this),i.load(new egret.URLRequest(t))},s.tip=function(){e.getInstance().visible=!e.getInstance().visible,e.getInstance().bg||(e.getInstance().bg=new egret.Sprite,e.getInstance().bg.graphics.beginFill(0,.7),e.getInstance().bg.graphics.drawRect(0,0,e.sw(),e.sh()),e.getInstance().bg.graphics.endFill(),e.getInstance().addChild(e.getInstance().bg))},e.randomArr=function(t){for(var e=t,i=e.length;i>-1;)e.push(e.splice(Math.floor(Math.random()*i),1)[0]),i--;return e},s.tipWin=function(){e.getInstance().visible=!e.getInstance().visible},s.initObjOffset=function(t){t.anchorOffsetX=t.width/2,t.anchorOffsetY=t.height/2},e}(egret.Sprite);egret.registerClass(Tools,"Tools");